<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vote Interface</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="vstyle.css">
</head>

<body>
    <div id="output">
        <h2>Check Active Proposal</h2>
        <button id="connectBtn">Connect</button>
        <button id="disconnectBtn" style="display:none;">Disconnect</button>
        <span id="loadingStatus" style="display: none;">Loading...</span>
        <ul id="functionList"></ul>
    </div>
    <div id="explainerTextContainer">
        <p id="explainerText"></p>
        <div id="voteInterface" style="display: none;">
            <label for="voteAmount_proposalActive">Amount:</label>
            <input type="number" id="voteAmount_proposalActive" placeholder="Enter amount in Ether">
            <button onclick="app.vote(true)">Vote In Favor</button>
            <button onclick="app.vote(false)">Vote Against</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/web3@4.1.2/dist/web3.min.js"></script>
    <script src="abi.js"></script>
    <script>
        class EthereumApp {
            constructor() {
                this.web3 = new Web3(new Web3.providers.HttpProvider("https://opbnb-testnet-rpc.bnbchain.org"));
                this.contract = new this.web3.eth.Contract(ABI, contractAddress);
                this.currentAccount = null;
            }

            async connect() {
                const accounts = await ethereum.request({ method: 'eth_requestAccounts' });
                this.currentAccount = accounts[0];
                return this.currentAccount;
            }

            async checkProposalStatus() {
                const proposalActive = await this.contract.methods.proposalActive().call();
                if (!proposalActive) {
                    return "No active proposal at the moment.";
                } else {
                    const proposalAmountWei = await this.contract.methods.proposalAmount().call();
                    const proposalAmount = this.web3.utils.fromWei(proposalAmountWei, 'ether');

                    const proposalDescription = await this.contract.methods.proposalDescription().call();
                    const proposalExpiryBigInt = await this.contract.methods.proposalExpiry().call();
                    const proposalExpiry = new Date(Number(proposalExpiryBigInt) * 1000).toLocaleString();

                    return `There is an active proposal by the developers requesting the release of ${proposalAmount} tokens.<br>
                            The reason provided for this proposal is: "${proposalDescription}".<br>
                            The proposal will expire on ${proposalExpiry}.`;
                }
            }
        }

        const app = new EthereumApp();

        async function main() {
            const btn = document.getElementById("connectBtn");
            const disconnectBtn = document.getElementById("disconnectBtn");
            const explainerText = document.getElementById("explainerText");
            const voteInterface = document.getElementById("voteInterface");

            btn.onclick = async function () {
                btn.innerText = "Connecting...";
                await app.connect();
                const status = await app.checkProposalStatus();
                explainerText.innerHTML = status;

                const proposalActive = await app.contract.methods.proposalActive().call();
                if (proposalActive) {
                    voteInterface.style.display = "block";
                } else {
                    voteInterface.style.display = "none";
                }

                btn.style.display = "none";
                disconnectBtn.style.display = "block";
            }

            disconnectBtn.onclick = function () {
                explainerText.innerHTML = "";
                voteInterface.style.display = "none";
                disconnectBtn.style.display = "none";
                btn.innerText = "Connect";
                btn.style.display = "block";
            }
        }

        main();
    </script>

</body>

</html>
