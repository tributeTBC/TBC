<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vote Interface</title>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="vstyle.css">
</head>

<body>
    <div id="output">
        <h2>Check Active Proposal</h2>
        <button id="connectBtn">Connect to Ethereum</button>
        <button id="disconnectBtn" style="display:none;">Disconnect</button>
        <span id="loadingIndicator" style="display: none;">Loading...</span>
        <ul id="functionList"></ul>
    </div>
    <div id="explainerTextContainer">
        <p id="explainerText"></p>
        <div id="voteInterface" style="display: none;">
            <label for="voteAmount_proposalActive">Amount:</label>
            <input type="number" id="voteAmount_proposalActive" placeholder="Enter amount in Ether">
            <button onclick="app.castVote(true)">Vote In Favor</button>
            <button onclick="app.castVote(false)">Vote Against</button>
        </div>
    </div>

    <script src="abi.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.3.5/dist/web3.min.js"></script>
    <script>
        const contractAddress = "0x6227F8e5D2d94De5310d6d46Fb698C4C6ADd143D";
        class EthereumApp {
            constructor(web3, contractAddress) {
                this.web3 = web3;
                this.contract = new web3.eth.Contract(ABI, contractAddress);
            }

            async checkProposalStatus() {
                const proposalActive = await this.contract.methods.proposalActive().call();
                if (proposalActive) {
                    const proposalDetails = await this.contract.methods.getProposalDetails().call();
                    return proposalDetails;
                } else {
                    return null;
                }
            }

            async castVote(inFavor, amount) {
                const voteTx = await this.contract.methods.castVote(inFavor, amount).send();
                return voteTx;
            }
        }

        const app = new EthereumApp(web3, contractAddress);

        async function main() {
            const proposalStatus = await app.checkProposalStatus();
            if (proposalStatus) {
                // Display the proposal details to the user.
                document.getElementById("explainerText").textContent = `
          There is an active proposal with the following details:
          * Amount: ${proposalStatus.amount} Ether
          * Description: ${proposalStatus.description}
          * Expiry: ${proposalStatus.expiry}
        `;

                // Allow the user to cast a vote.
                document.getElementById("voteInterface").style.display = "block";
            } else {
                // Display a message to the user that there is no active proposal.
                document.getElementById("explainerText").textContent = "There is currently no active proposal.";
            }
        }

        document.getElementById("connectBtn").addEventListener("click", async () => {
            await app.connectToEthereum();
        });

        document.getElementById("disconnectBtn").addEventListener("click", async () => {
            await app.disconnect();
        });

        document.getElementById("voteForm").addEventListener("submit", async (event) => {
            event.preventDefault();

            const voteAmount = document.getElementById("voteAmount_proposalActive").value;

            await app.castVote(true, voteAmount);

            // Display a message to the user that their vote has been cast.
            document.getElementById("explainerText").textContent = "Your vote has been cast successfully!";
        });

        main();
    </script>
</body>

</html>
